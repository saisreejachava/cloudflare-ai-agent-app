<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cloudflare Agents Chat</title>
    <style>
      :root {
        color-scheme: dark;
        --bg-0: #05101a;
        --bg-1: #10283d;
        --bg-2: #163b56;
        --panel: rgba(6, 18, 30, 0.74);
        --panel-border: rgba(132, 182, 220, 0.3);
        --text: #e9f5ff;
        --muted: #98bfdc;
        --ok: #22c55e;
        --warn: #fb7185;
        --user: linear-gradient(140deg, #fb923c, #f97316);
        --assistant: linear-gradient(150deg, #123750, #1a4e72);
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        margin: 0;
        min-height: 100%;
      }

      body {
        font-family: "Space Grotesk", "Avenir Next", "Trebuchet MS", sans-serif;
        color: var(--text);
        background:
          radial-gradient(circle at 10% 8%, rgba(125, 211, 252, 0.2), transparent 33%),
          radial-gradient(circle at 88% 85%, rgba(251, 146, 60, 0.16), transparent 36%),
          linear-gradient(160deg, var(--bg-0), var(--bg-1) 45%, var(--bg-2));
      }

      .ambient {
        position: fixed;
        border-radius: 999px;
        pointer-events: none;
        filter: blur(45px);
        opacity: 0.35;
        animation: float 10s ease-in-out infinite;
      }

      .ambient-a {
        width: 360px;
        height: 360px;
        left: -120px;
        top: -90px;
        background: #38bdf8;
      }

      .ambient-b {
        width: 300px;
        height: 300px;
        right: -80px;
        bottom: -60px;
        background: #fb923c;
        animation-delay: -3s;
      }

      .ambient-c {
        width: 220px;
        height: 220px;
        right: 26%;
        top: 12%;
        opacity: 0.2;
        background: #34d399;
        animation-delay: -1.7s;
      }

      .wrap {
        position: relative;
        z-index: 1;
        max-width: 1080px;
        min-height: 100dvh;
        margin: 0 auto;
        padding: 24px;
        display: grid;
        place-items: center;
      }

      .card {
        width: min(1020px, 100%);
        height: min(90dvh, 820px);
        display: grid;
        grid-template-rows: auto auto 1fr auto auto;
        border-radius: 24px;
        border: 1px solid var(--panel-border);
        background: var(--panel);
        backdrop-filter: blur(12px);
        box-shadow: 0 20px 70px rgba(0, 8, 16, 0.58);
        overflow: hidden;
        animation: enter 420ms ease;
      }

      header {
        padding: 16px 18px;
        border-bottom: 1px solid var(--panel-border);
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 14px;
      }

      .title {
        margin: 0;
        font-size: clamp(1.1rem, 2vw, 1.55rem);
      }

      .subtitle {
        margin: 6px 0 0;
        color: var(--muted);
        font-size: 0.85rem;
      }

      .status {
        border-radius: 999px;
        border: 1px solid;
        padding: 6px 11px;
        font-size: 0.8rem;
        background: rgba(4, 13, 22, 0.86);
      }

      .status.online {
        color: var(--ok);
        border-color: rgba(34, 197, 94, 0.45);
      }

      .status.offline {
        color: var(--warn);
        border-color: rgba(251, 113, 133, 0.45);
      }

      .toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        padding: 12px 16px;
        border-bottom: 1px solid var(--panel-border);
      }

      .ghost {
        border: 1px solid rgba(146, 194, 228, 0.35);
        color: var(--text);
        background: rgba(8, 24, 37, 0.8);
        border-radius: 11px;
        padding: 8px 11px;
        font: inherit;
        font-size: 0.8rem;
        cursor: pointer;
      }

      .ghost:hover {
        border-color: rgba(125, 211, 252, 0.75);
      }

      .attachment-bar {
        display: none;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        margin: 0 16px;
        padding: 10px 12px;
        border: 1px solid rgba(146, 194, 228, 0.35);
        border-radius: 12px;
        background: rgba(7, 24, 38, 0.82);
      }

      .attachment-bar.active {
        display: flex;
      }

      .attachment-left {
        display: flex;
        align-items: center;
        gap: 10px;
        min-width: 0;
      }

      .attachment-preview {
        width: 52px;
        height: 52px;
        border-radius: 10px;
        object-fit: cover;
        border: 1px solid rgba(146, 194, 228, 0.45);
      }

      .attachment-name {
        color: var(--muted);
        font-size: 0.8rem;
        text-overflow: ellipsis;
        white-space: nowrap;
        overflow: hidden;
        max-width: 220px;
      }

      .chat {
        overflow: auto;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .empty {
        margin: auto;
        text-align: center;
        max-width: 560px;
      }

      .empty h2 {
        margin: 0 0 7px;
      }

      .empty p {
        margin: 0;
        color: var(--muted);
      }

      .prompts {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 14px;
        justify-content: center;
      }

      .prompt-chip {
        border: 1px solid rgba(146, 194, 228, 0.35);
        border-radius: 999px;
        background: rgba(8, 24, 37, 0.8);
        color: var(--text);
        padding: 6px 10px;
        font: inherit;
        font-size: 0.78rem;
        cursor: pointer;
      }

      .prompt-chip:hover {
        border-color: rgba(125, 211, 252, 0.75);
      }

      .msg {
        max-width: min(84%, 76ch);
        border-radius: 16px;
        border: 1px solid rgba(159, 202, 233, 0.2);
        padding: 10px 12px;
        line-height: 1.42;
        animation: bubble 220ms ease both;
      }

      .msg.assistant {
        align-self: flex-start;
        background: var(--assistant);
      }

      .msg.user {
        align-self: flex-end;
        background: var(--user);
        color: #fff7ed;
      }

      .msg-head {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        margin-bottom: 6px;
        font-size: 0.72rem;
        text-transform: uppercase;
        letter-spacing: 0.07em;
      }

      .msg-time {
        opacity: 0.75;
      }

      .copy {
        border: 0;
        background: transparent;
        color: inherit;
        opacity: 0.82;
        font-size: 0.7rem;
        cursor: pointer;
      }

      .copy:hover {
        opacity: 1;
      }

      .msg-body {
        margin: 0;
        white-space: pre-wrap;
      }

      .msg-image {
        max-width: min(100%, 380px);
        margin-top: 8px;
        border-radius: 12px;
        border: 1px solid rgba(146, 194, 228, 0.35);
        display: block;
      }

      .msg.streaming .msg-body::after {
        content: "";
        display: inline-block;
        width: 8px;
        height: 1em;
        margin-left: 2px;
        vertical-align: -2px;
        border-radius: 2px;
        background: rgba(219, 234, 254, 0.9);
        animation: caret 850ms infinite;
      }

      .composer {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 12px;
        padding: 14px 16px;
        border-top: 1px solid var(--panel-border);
      }

      textarea {
        width: 100%;
        min-height: 60px;
        max-height: 170px;
        resize: none;
        border-radius: 13px;
        border: 1px solid rgba(146, 194, 228, 0.45);
        background: rgba(6, 16, 27, 0.84);
        color: var(--text);
        font: inherit;
        padding: 12px;
        outline: none;
      }

      textarea:focus {
        border-color: rgba(56, 189, 248, 0.95);
        box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.18);
      }

      .send {
        min-width: 128px;
        border: 0;
        border-radius: 13px;
        background: linear-gradient(140deg, #38bdf8, #0ea5e9);
        color: #052238;
        font-family: inherit;
        font-weight: 800;
        cursor: pointer;
      }

      .send:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .meta {
        padding: 10px 16px;
        border-top: 1px solid var(--panel-border);
        background: rgba(5, 16, 26, 0.82);
        color: var(--muted);
        display: flex;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
        font-size: 0.8rem;
      }

      code {
        color: #d9efff;
        background: rgba(5, 15, 24, 0.88);
        border: 1px solid var(--panel-border);
        border-radius: 9px;
        padding: 3px 7px;
      }

      @keyframes enter {
        from {
          opacity: 0;
          transform: translateY(12px) scale(0.986);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      @keyframes bubble {
        from {
          opacity: 0;
          transform: translateY(6px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes caret {
        0%,
        100% {
          opacity: 0.2;
        }
        50% {
          opacity: 0.9;
        }
      }

      @keyframes float {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(10px);
        }
      }

      @media (max-width: 820px) {
        .wrap {
          padding: 12px;
        }

        .card {
          height: calc(100dvh - 24px);
          border-radius: 18px;
        }

        header {
          flex-direction: column;
          align-items: flex-start;
        }

        .composer {
          grid-template-columns: 1fr;
        }

        .send {
          min-height: 44px;
        }

        .msg {
          max-width: 92%;
        }
      }
    </style>
  </head>
  <body>
    <div class="ambient ambient-a"></div>
    <div class="ambient ambient-b"></div>
    <div class="ambient ambient-c"></div>

    <div class="wrap">
      <section class="card">
        <header>
          <div>
            <h1 class="title">Cloudflare Agents Chat: Turbo Mode</h1>
            <p class="subtitle">Realtime AI, persistent memory, and cinematic UI motion</p>
          </div>
          <span id="status" class="status offline">Connecting...</span>
        </header>

        <div class="toolbar">
          <button id="attach" class="ghost" type="button">Attach image</button>
          <button id="clear" class="ghost" type="button">Clear chat</button>
          <button id="surprise" class="ghost" type="button">Surprise prompt</button>
          <button id="export" class="ghost" type="button">Export transcript</button>
        </div>

        <div id="chat" class="chat">
          <div id="empty" class="empty">
            <h2>Make it wild</h2>
            <p>Use quick prompts, stream answers, and keep context with Durable Object memory.</p>
            <div id="quickPrompts" class="prompts"></div>
          </div>
        </div>

        <div id="attachmentBar" class="attachment-bar">
          <div class="attachment-left">
            <img id="attachmentPreview" class="attachment-preview" alt="Selected upload preview" />
            <span id="attachmentName" class="attachment-name"></span>
          </div>
          <button id="removeAttachment" class="ghost" type="button">Remove</button>
        </div>

        <div class="composer">
          <textarea id="input" placeholder="Ask anything... (Shift+Enter for newline)"></textarea>
          <button id="send" class="send" type="button" disabled>Send</button>
        </div>

        <div class="meta">
          <span>Agent id: <code id="agentId"></code></span>
          <span id="stats">0 messages</span>
        </div>
      </section>
    </div>
    <input id="imageInput" type="file" accept="image/*" hidden />

    <script type="module">
      const key = "cf_agent_demo_id";
      const defaultPrompts = [
        "Give me a 5-day interview prep plan for cloud engineering.",
        "Create a startup idea using AI agents + edge computing.",
        "Teach me Durable Objects like I am a beginner.",
        "Write a polished README section for my project."
      ];

      let agentId = localStorage.getItem(key);
      if (!agentId) {
        agentId = crypto.randomUUID();
        localStorage.setItem(key, agentId);
      }

      const chatEl = document.getElementById("chat");
      const inputEl = document.getElementById("input");
      const sendBtn = document.getElementById("send");
      const statusEl = document.getElementById("status");
      const emptyEl = document.getElementById("empty");
      const statsEl = document.getElementById("stats");
      const promptWrapEl = document.getElementById("quickPrompts");
      const attachBtn = document.getElementById("attach");
      const clearBtn = document.getElementById("clear");
      const exportBtn = document.getElementById("export");
      const surpriseBtn = document.getElementById("surprise");
      const imageInputEl = document.getElementById("imageInput");
      const attachmentBarEl = document.getElementById("attachmentBar");
      const attachmentPreviewEl = document.getElementById("attachmentPreview");
      const attachmentNameEl = document.getElementById("attachmentName");
      const removeAttachmentBtn = document.getElementById("removeAttachment");
      document.getElementById("agentId").textContent = agentId;

      let ws;
      let reconnectTimer;
      let streamBubble = null;
      let streamText = "";
      let selectedImageDataUrl = "";
      let selectedImageName = "";

      function nowTime() {
        return new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
      }

      function setStatus(text, online) {
        statusEl.textContent = text;
        statusEl.classList.toggle("online", online);
        statusEl.classList.toggle("offline", !online);
      }

      function setStats() {
        const count = chatEl.querySelectorAll(".msg").length;
        statsEl.textContent = `${count} message${count === 1 ? "" : "s"}`;
      }

      function hideEmpty() {
        if (emptyEl) emptyEl.style.display = "none";
      }

      function showEmptyIfNeeded() {
        if (!emptyEl) return;
        const hasMessage = chatEl.querySelector(".msg");
        if (hasMessage) {
          emptyEl.style.display = "none";
        } else {
          emptyEl.style.display = "";
          if (!emptyEl.isConnected) chatEl.appendChild(emptyEl);
        }
      }

      function scrollToEnd() {
        chatEl.scrollTop = chatEl.scrollHeight;
      }

      function copyMessage(text) {
        navigator.clipboard.writeText(text).catch(() => {});
      }

      function clearAttachment() {
        selectedImageDataUrl = "";
        selectedImageName = "";
        imageInputEl.value = "";
        attachmentBarEl.classList.remove("active");
      }

      function setAttachment(dataUrl, name) {
        selectedImageDataUrl = dataUrl;
        selectedImageName = name || "image upload";
        attachmentPreviewEl.src = dataUrl;
        attachmentNameEl.textContent = selectedImageName;
        attachmentBarEl.classList.add("active");
      }

      function createMessage(role, text, options = {}) {
        hideEmpty();
        const item = document.createElement("article");
        item.className = `msg ${role}`;
        if (options.streaming) item.classList.add("streaming");

        const head = document.createElement("div");
        head.className = "msg-head";

        const title = document.createElement("span");
        title.textContent = role === "user" ? "You" : "Assistant";

        const right = document.createElement("span");
        right.className = "msg-time";
        right.textContent = nowTime();

        head.appendChild(title);

        if (role === "assistant" && !options.streaming) {
          const copyBtn = document.createElement("button");
          copyBtn.className = "copy";
          copyBtn.type = "button";
          copyBtn.textContent = "Copy";
          copyBtn.addEventListener("click", () => copyMessage(text));
          head.appendChild(copyBtn);
        }

        head.appendChild(right);

        const body = document.createElement("p");
        body.className = "msg-body";
        body.textContent = text;

        item.appendChild(head);
        item.appendChild(body);
        if (options.imageDataUrl) {
          const image = document.createElement("img");
          image.className = "msg-image";
          image.src = options.imageDataUrl;
          image.alt = "Uploaded image";
          item.appendChild(image);
        }
        chatEl.appendChild(item);
        scrollToEnd();
        setStats();
        return { item, body };
      }

      function startStreaming() {
        if (streamBubble) return;
        streamText = "";
        streamBubble = createMessage("assistant", "", { streaming: true });
      }

      function updateStreaming(chunk) {
        startStreaming();
        streamText += chunk;
        streamBubble.body.textContent = streamText;
        scrollToEnd();
      }

      function finishStreaming(finalText) {
        if (!streamBubble) {
          createMessage("assistant", finalText);
          return;
        }

        const finalContent = finalText || streamText;
        const old = streamBubble.item;
        streamBubble = null;
        old.remove();
        createMessage("assistant", finalContent);
      }

      function renderPrompts() {
        promptWrapEl.innerHTML = "";
        for (const prompt of defaultPrompts) {
          const chip = document.createElement("button");
          chip.className = "prompt-chip";
          chip.type = "button";
          chip.textContent = prompt;
          chip.addEventListener("click", () => {
            inputEl.value = prompt;
            inputEl.dispatchEvent(new Event("input"));
            inputEl.focus();
          });
          promptWrapEl.appendChild(chip);
        }
      }

      function exportChat() {
        const rows = Array.from(chatEl.querySelectorAll(".msg")).map((node) => {
          const role = node.classList.contains("user") ? "User" : "Assistant";
          const body = node.querySelector(".msg-body")?.textContent || "";
          const hasImage = Boolean(node.querySelector(".msg-image"));
          const imageLine = hasImage ? "\n[Image attached]\n" : "";
          return `## ${role}\n${body}${imageLine}\n`;
        });

        const blob = new Blob([rows.join("\n") || "No messages yet."], { type: "text/markdown;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = `chat-${agentId.slice(0, 8)}.md`;
        link.click();
        URL.revokeObjectURL(url);
      }

      const wsUrl =
        (location.protocol === "https:" ? "wss://" : "ws://") +
        location.hostname +
        (location.port ? `:${location.port}` : "") +
        `/agents/chat-agent/${agentId}`;

      function connect() {
        clearTimeout(reconnectTimer);
        setStatus("Connecting...", false);
        sendBtn.disabled = true;

        ws = new WebSocket(wsUrl);

        ws.onopen = () => {
          setStatus("Online", true);
          sendBtn.disabled = false;
        };

        ws.onmessage = (evt) => {
          const msg = JSON.parse(evt.data);

          if (msg.type === "history") {
            chatEl.querySelectorAll(".msg").forEach((n) => n.remove());
            streamBubble = null;
            streamText = "";

            if (Array.isArray(msg.messages) && msg.messages.length) {
              for (const m of msg.messages) createMessage(m.role, m.content, { imageDataUrl: m.imageDataUrl });
            }
            showEmptyIfNeeded();
            setStats();
            return;
          }

          if (msg.type === "assistant_start") {
            startStreaming();
            return;
          }

          if (msg.type === "assistant_chunk" && typeof msg.content === "string") {
            updateStreaming(msg.content);
            return;
          }

          if (msg.type === "assistant_done") {
            finishStreaming(typeof msg.content === "string" ? msg.content : streamText);
            return;
          }

          if (msg.type === "assistant" && !streamBubble) {
            const lastBody = chatEl.querySelector(".msg.assistant:last-child .msg-body");
            if (lastBody && lastBody.textContent === msg.content) return;
            createMessage("assistant", msg.content);
          }
        };

        ws.onclose = () => {
          setStatus("Reconnecting...", false);
          sendBtn.disabled = true;
          reconnectTimer = setTimeout(connect, 850);
        };

        ws.onerror = () => {
          setStatus("Connection issue", false);
          sendBtn.disabled = true;
          try {
            ws.close();
          } catch {}
        };
      }

      function send() {
        const text = inputEl.value.trim();
        const hasImage = Boolean(selectedImageDataUrl);
        if ((!text && !hasImage) || !ws || ws.readyState !== WebSocket.OPEN) return;

        const userText = text || "Please analyze this image.";
        createMessage("user", userText, { imageDataUrl: selectedImageDataUrl || undefined });
        ws.send(
          JSON.stringify({
            type: "user",
            content: userText,
            imageDataUrl: hasImage ? selectedImageDataUrl : undefined
          })
        );
        inputEl.value = "";
        inputEl.style.height = "auto";
        clearAttachment();
      }

      sendBtn.addEventListener("click", send);

      attachBtn.addEventListener("click", () => imageInputEl.click());

      imageInputEl.addEventListener("change", () => {
        const file = imageInputEl.files?.[0];
        if (!file) return;

        if (!file.type.startsWith("image/")) {
          return;
        }

        if (file.size > 4 * 1024 * 1024) {
          alert("Please upload an image under 4MB.");
          clearAttachment();
          return;
        }

        const reader = new FileReader();
        reader.onload = () => {
          if (typeof reader.result === "string") {
            setAttachment(reader.result, file.name);
          }
        };
        reader.readAsDataURL(file);
      });

      removeAttachmentBtn.addEventListener("click", clearAttachment);

      inputEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          send();
        }
      });

      inputEl.addEventListener("input", () => {
        inputEl.style.height = "auto";
        inputEl.style.height = `${Math.min(inputEl.scrollHeight, 170)}px`;
      });

      clearBtn.addEventListener("click", () => {
        chatEl.querySelectorAll(".msg").forEach((n) => n.remove());
        showEmptyIfNeeded();
        setStats();
        streamBubble = null;
        streamText = "";
        clearAttachment();
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ type: "reset" }));
        }
      });

      exportBtn.addEventListener("click", exportChat);

      surpriseBtn.addEventListener("click", () => {
        const randomPrompt = defaultPrompts[Math.floor(Math.random() * defaultPrompts.length)];
        inputEl.value = randomPrompt;
        inputEl.dispatchEvent(new Event("input"));
        inputEl.focus();
      });

      renderPrompts();
      showEmptyIfNeeded();
      setStats();
      connect();
    </script>
  </body>
</html>
