<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cloudflare Agents Chat</title>
    <style>
      :root { color-scheme: dark; }
      body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background: #0b0f19; color: #e8ecf1; }
      .wrap { max-width: 900px; margin: 0 auto; padding: 24px; }
      .card { background: #121a2b; border: 1px solid #223154; border-radius: 16px; overflow: hidden; }
      header { padding: 16px 18px; border-bottom: 1px solid #223154; display:flex; justify-content: space-between; align-items:center; gap: 12px; }
      header h1 { font-size: 16px; margin: 0; font-weight: 650; letter-spacing: .2px; }
      header .pill { font-size: 12px; padding: 6px 10px; border-radius: 999px; background: #0e1430; border: 1px solid #223154; color: #b6c2dd; }
      .chat { height: 520px; overflow:auto; padding: 16px 18px; display:flex; flex-direction:column; gap: 10px;}
      .msg { max-width: 80%; padding: 10px 12px; border-radius: 14px; border: 1px solid #223154; white-space: pre-wrap; line-height: 1.35; }
      .user { align-self:flex-end; background: #1a2a56; }
      .assistant { align-self:flex-start; background: #111827; }
      .row { display:flex; gap: 10px; padding: 14px 18px; border-top: 1px solid #223154; }
      textarea { flex:1; resize:none; height: 48px; border-radius: 12px; border: 1px solid #223154; background:#0e1430; color:#e8ecf1; padding: 10px 12px; font-size: 14px; }
      button { width: 120px; border-radius: 12px; border: 1px solid #223154; background:#2b4fe5; color:white; font-weight: 650; cursor:pointer; }
      button:disabled { opacity: .6; cursor:not-allowed; }
      .hint { padding: 10px 18px; color:#b6c2dd; font-size: 12px; border-top: 1px solid #223154; background:#0e1430; }
      code { background:#0e1430; padding:2px 6px; border-radius: 8px; border: 1px solid #223154; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="card">
        <header>
          <h1>Cloudflare Agents Chat (Workers AI + Durable State)</h1>
          <span id="status">Connecting...</span>
        </header>

        <div id="chat" class="chat"></div>

        <div class="row">
          <textarea id="input" placeholder="Ask something… (Shift+Enter for newline)"></textarea>
          <button id="send" disabled>Send</button>
        </div>

        <div class="hint">
          This app uses an <b>Agent</b> (Durable Object) for memory/state, <b>Workers AI</b> for Llama 3.3, and a <b>WebSocket</b> for real-time chat.
          Agent instance id: <code id="agentId"></code>
        </div>
      </div>
    </div>

    <script type="module">
      // Generate a stable-ish id for this browser (no auth required)
      const key = "cf_agent_demo_id";
      let agentId = localStorage.getItem(key);
      if (!agentId) {
        agentId = crypto.randomUUID();
        localStorage.setItem(key, agentId);
      }
      document.getElementById("agentId").textContent = agentId;

      const chatEl = document.getElementById("chat");
      const inputEl = document.getElementById("input");
      const sendBtn = document.getElementById("send");
      const statusEl = document.getElementById("status");

      function add(role, text) {
        const div = document.createElement("div");
        div.className = "msg " + (role === "user" ? "user" : "assistant");
        div.textContent = text;
        chatEl.appendChild(div);
        chatEl.scrollTop = chatEl.scrollHeight;
      }

      function setStatus(text) {
        statusEl.textContent = text;
      }

      // Connect to the agent via websocket
      const wsUrl =
        (location.protocol === "https:" ? "wss://" : "ws://") +
        location.hostname +
        (location.port ? ":" + location.port : "") +
        `/agents/chat-agent/${agentId}`;

      let ws;

      function connect() {
        setStatus("Connecting…");
        sendBtn.disabled = true;

        ws = new WebSocket(wsUrl);

        ws.onopen = () => {
          console.log("Connection established");
          setStatus("Online");
          sendBtn.disabled = false;
        };

        ws.onmessage = (evt) => {
          const msg = JSON.parse(evt.data);
          if (msg.type === "history") {
            chatEl.innerHTML = "";
            for (const m of msg.messages) add(m.role, m.content);
          }
          if (msg.type === "assistant") add("assistant", msg.content);
        };

        ws.onclose = () => {
          setStatus("Disconnected (retrying…)");
          sendBtn.disabled = true;
          setTimeout(connect, 800);
        };

        ws.onerror = () => {
          setStatus("Error (retrying…)");
          sendBtn.disabled = true;
          try { ws.close(); } catch {}
        };
      }

      connect();

      function send() {
        const text = inputEl.value.trim();
        if (!text || !ws || ws.readyState !== WebSocket.OPEN) return;
        add("user", text);
        ws.send(JSON.stringify({ type: "user", content: text }));
        inputEl.value = "";
      }

      sendBtn.addEventListener("click", send);
      inputEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          send();
        }
      });
    </script>
  </body>
</html>
