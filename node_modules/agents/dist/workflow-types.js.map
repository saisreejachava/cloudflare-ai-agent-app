{"version":3,"file":"workflow-types.js","names":[],"sources":["../src/workflow-types.ts"],"sourcesContent":["/**\n * Workflow integration types for Agents\n *\n * These types provide seamless integration between Cloudflare Agents\n * and Cloudflare Workflows for durable, multi-step background processing.\n *\n * Note: This file is kept separate from workflows.ts to avoid circular dependencies.\n * Both index.ts (Agent class) and workflows.ts (AgentWorkflow class) import from here.\n */\n\nimport type {\n  WorkflowEvent,\n  WorkflowStep,\n  WorkflowSleepDuration\n} from \"cloudflare:workers\";\n\n/**\n * Type alias for WorkflowEvent in AgentWorkflow context.\n * Identical to WorkflowEvent - provided for naming consistency with AgentWorkflowStep.\n */\nexport type AgentWorkflowEvent<Params = unknown> = WorkflowEvent<Params>;\n\n/**\n * Extended WorkflowStep with durable Agent communication methods.\n * All added methods on this interface are durable - they're idempotent and won't\n * repeat on workflow retry.\n */\nexport interface AgentWorkflowStep extends WorkflowStep {\n  /**\n   * Report successful completion to the Agent (durable).\n   * Triggers onWorkflowComplete() on the Agent.\n   * @param result - Optional result data\n   */\n  reportComplete<T = unknown>(result?: T): Promise<void>;\n\n  /**\n   * Report an error to the Agent (durable).\n   * Triggers onWorkflowError() on the Agent.\n   * @param error - Error or error message\n   */\n  reportError(error: Error | string): Promise<void>;\n\n  /**\n   * Send a custom event to the Agent (durable).\n   * Triggers onWorkflowEvent() on the Agent.\n   * @param event - Custom event payload\n   */\n  sendEvent<T = unknown>(event: T): Promise<void>;\n\n  /**\n   * Update the Agent's state entirely (durable).\n   * This will replace the Agent's state and broadcast to all connected clients.\n   * @param state - New state to set\n   */\n  updateAgentState(state: unknown): Promise<void>;\n\n  /**\n   * Merge partial state into the Agent's existing state (durable).\n   * Performs a shallow merge and broadcasts to all connected clients.\n   * @param partialState - Partial state to merge\n   */\n  mergeAgentState(partialState: Record<string, unknown>): Promise<void>;\n\n  /**\n   * Reset the Agent's state to its initialState (durable).\n   * Broadcasts the reset state to all connected clients.\n   */\n  resetAgentState(): Promise<void>;\n}\n\n/**\n * Internal parameters injected by runWorkflow() to identify the originating Agent\n */\nexport type AgentWorkflowInternalParams = {\n  /** Name/ID of the Agent that started this workflow */\n  __agentName: string;\n  /** Environment binding name for the Agent's namespace */\n  __agentBinding: string;\n  /** Workflow binding name (for callbacks) */\n  __workflowName: string;\n};\n\n/**\n * Combined workflow params: user params + internal agent params\n */\nexport type AgentWorkflowParams<T = unknown> = T & AgentWorkflowInternalParams;\n\n/**\n * Workflow callback types for Agent-Workflow communication\n */\nexport type WorkflowCallbackType = \"progress\" | \"complete\" | \"error\" | \"event\";\n\n/**\n * Base callback structure sent from Workflow to Agent\n */\nexport type WorkflowCallbackBase = {\n  /** Workflow binding name */\n  workflowName: string;\n  /** ID of the workflow instance */\n  workflowId: string;\n  /** Type of callback */\n  type: WorkflowCallbackType;\n  /** Timestamp when callback was sent */\n  timestamp: number;\n};\n\n/**\n * Default progress type - covers common use cases.\n * Developers can define their own progress type for domain-specific needs.\n */\nexport type DefaultProgress = {\n  /** Current step name */\n  step?: string;\n  /** Step/overall status */\n  status?: \"pending\" | \"running\" | \"complete\" | \"error\";\n  /** Human-readable message */\n  message?: string;\n  /** Progress percentage (0-1) */\n  percent?: number;\n  /** Allow additional custom fields */\n  [key: string]: unknown;\n};\n\n/**\n * Progress callback - reports workflow progress with typed payload\n */\nexport type WorkflowProgressCallback<P = DefaultProgress> =\n  WorkflowCallbackBase & {\n    type: \"progress\";\n    /** Typed progress data */\n    progress: P;\n  };\n\n/**\n * Complete callback - workflow finished successfully\n */\nexport type WorkflowCompleteCallback = WorkflowCallbackBase & {\n  type: \"complete\";\n  /** Result of the workflow */\n  result?: unknown;\n};\n\n/**\n * Error callback - workflow encountered an error\n */\nexport type WorkflowErrorCallback = WorkflowCallbackBase & {\n  type: \"error\";\n  /** Error message */\n  error: string;\n};\n\n/**\n * Event callback - custom event from workflow\n */\nexport type WorkflowEventCallback = WorkflowCallbackBase & {\n  type: \"event\";\n  /** Custom event payload */\n  event: unknown;\n};\n\n/**\n * Union of all callback types\n */\nexport type WorkflowCallback<P = DefaultProgress> =\n  | WorkflowProgressCallback<P>\n  | WorkflowCompleteCallback\n  | WorkflowErrorCallback\n  | WorkflowEventCallback;\n\n/**\n * Workflow status values - derived from Cloudflare's InstanceStatus\n */\nexport type WorkflowStatus = InstanceStatus[\"status\"];\n\n/**\n * Row structure for cf_agents_workflows tracking table\n */\nexport type WorkflowTrackingRow = {\n  /** Internal row ID (UUID) */\n  id: string;\n  /** Cloudflare Workflow instance ID */\n  workflow_id: string;\n  /** Workflow binding name */\n  workflow_name: string;\n  /** Current workflow status */\n  status: WorkflowStatus;\n  /** JSON-serialized metadata for querying */\n  metadata: string | null;\n  /** Error name if workflow failed */\n  error_name: string | null;\n  /** Error message if workflow failed */\n  error_message: string | null;\n  /** Unix timestamp when workflow was created */\n  created_at: number;\n  /** Unix timestamp when workflow was last updated */\n  updated_at: number;\n  /** Unix timestamp when workflow completed (null if not complete) */\n  completed_at: number | null;\n};\n\n/**\n * Options for runWorkflow()\n */\nexport type RunWorkflowOptions = {\n  /** Custom workflow instance ID (auto-generated if not provided) */\n  id?: string;\n  /** Optional metadata for querying (stored as JSON) */\n  metadata?: Record<string, unknown>;\n  /** Agent binding name (auto-detected from class name if not provided) */\n  agentBinding?: string;\n};\n\n/**\n * Event payload for sendWorkflowEvent()\n */\nexport type WorkflowEventPayload = {\n  /** Event type name */\n  type: string;\n  /** Event payload data */\n  payload: unknown;\n};\n\n/**\n * Parsed workflow tracking info returned by getWorkflow()\n */\nexport type WorkflowInfo = {\n  /** Internal row ID */\n  id: string;\n  /** Cloudflare Workflow instance ID */\n  workflowId: string;\n  /** Workflow binding name */\n  workflowName: string;\n  /** Current workflow status */\n  status: WorkflowStatus;\n  /** Metadata (parsed from JSON) */\n  metadata: Record<string, unknown> | null;\n  /** Error info if workflow failed */\n  error: { name: string; message: string } | null;\n  /** When workflow was created */\n  createdAt: Date;\n  /** When workflow was last updated */\n  updatedAt: Date;\n  /** When workflow completed (null if not complete) */\n  completedAt: Date | null;\n};\n\n/**\n * Criteria for querying tracked workflows\n */\nexport type WorkflowQueryCriteria = {\n  /** Filter by status */\n  status?: WorkflowStatus | WorkflowStatus[];\n  /** Filter by workflow binding name */\n  workflowName?: string;\n  /** Filter by metadata key-value pairs (exact match) */\n  metadata?: Record<string, string | number | boolean>;\n  /** Limit number of results (default 50, max 100) */\n  limit?: number;\n  /** Order by created_at */\n  orderBy?: \"asc\" | \"desc\";\n  /** Cursor for pagination (from previous WorkflowPage.nextCursor) */\n  cursor?: string;\n};\n\n/**\n * Paginated result from getWorkflows()\n */\nexport type WorkflowPage = {\n  /** Workflows for this page */\n  workflows: WorkflowInfo[];\n  /** Total count of workflows matching the criteria (ignoring pagination) */\n  total: number;\n  /** Cursor for next page, or null if no more pages */\n  nextCursor: string | null;\n};\n\n/**\n * Standard approval event payload used by approveWorkflow/rejectWorkflow\n */\nexport type ApprovalEventPayload = {\n  /** Whether the workflow was approved */\n  approved: boolean;\n  /** Optional reason for approval/rejection */\n  reason?: string;\n  /** Optional additional metadata */\n  metadata?: Record<string, unknown>;\n};\n\n/**\n * Options for waitForApproval()\n */\nexport type WaitForApprovalOptions = {\n  /** Step name for waitForEvent (default: \"wait-for-approval\") */\n  stepName?: string;\n  /** Timeout duration (e.g., \"7 days\") */\n  timeout?: WorkflowSleepDuration;\n  /** Event type to wait for (default: \"approval\") */\n  eventType?: string;\n};\n\n/**\n * Error thrown when a workflow is rejected via rejectWorkflow()\n */\nexport class WorkflowRejectedError extends Error {\n  constructor(\n    public readonly reason?: string,\n    public readonly workflowId?: string\n  ) {\n    super(reason ? `Workflow rejected: ${reason}` : \"Workflow rejected\");\n    this.name = \"WorkflowRejectedError\";\n  }\n}\n"],"mappings":";;;;AA+SA,IAAa,wBAAb,cAA2C,MAAM;CAC/C,YACE,AAAgB,QAChB,AAAgB,YAChB;AACA,QAAM,SAAS,sBAAsB,WAAW,oBAAoB;EAHpD;EACA;AAGhB,OAAK,OAAO"}